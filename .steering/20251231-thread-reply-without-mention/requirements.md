# 要件定義: スレッド内の返信はメンションなしでも反応する

## 概要

ボットが参加しているスレッド内の返信では、メンションなしでも反応するようにする。

関連Issue: [#17](https://github.com/foie0222/mynion/issues/17)

## 現状の問題

### 根本原因

**Slackアプリのイベント購読設定が不足している**

| 現在の設定 | 説明 |
|-----------|------|
| `app_mentions:read` | メンションがあるときのみイベント受信 |
| `channels:history` | チャンネル履歴を読み取る権限（API用） |
| `chat:write` | メッセージ送信権限 |

**`message`イベントを購読していないため、メンションなしのメッセージはLambdaに届かない**

### コード実装状況

`receiver.py`には以下のロジックがすでに実装済み:

1. `is_bot_in_thread()` - スレッド内にボットのメッセージがあるかチェック
2. `should_respond()` - 以下の条件で応答判定:
   - メンションがあれば反応
   - ボットが参加しているスレッド内の返信であれば反応

**コードのロジックは正しいが、イベントが届いていないため動作しない**

## 期待する動作

| 状況 | 反応 |
|------|------|
| メンションあり（どこでも） | する |
| ボットが参加しているスレッド内返信（メンションなし） | する |
| ボットが参加していないスレッド内返信 | しない |
| 通常メッセージ（メンションなし） | しない |

## 必要な対応

### 1. Slackアプリの設定変更

Event Subscriptionsで以下のイベントを追加購読:

| イベント | 説明 | 必須 |
|---------|------|------|
| `message.channels` | パブリックチャンネルのメッセージ | **Yes** |
| `message.groups` | プライベートチャンネルのメッセージ | Optional |
| `message.im` | DMのメッセージ | Optional |

### 2. コード変更

**コードの変更は不要** - ロジックはすでに実装済み

### 3. ローカルテスト環境の整備

デプロイ前にテストできるよう、以下を整備:

1. ユニットテストの追加（`is_bot_in_thread`, `should_respond`のテスト）
2. ローカルでのSlackイベント模擬テスト方法の文書化

## 受け入れ条件

- [ ] Slackアプリで`message.channels`イベントを購読している
- [ ] スレッド内でメンションなしでメッセージを送ると、ボットが反応する
- [ ] ボットが参加していないスレッドでは反応しない
- [ ] 通常のチャンネルメッセージ（スレッド外）ではメンションなしでは反応しない
- [ ] ユニットテストが追加されている

## 制約事項

- APIレート制限: `conversations.replies`を毎回呼ぶため、高頻度メッセージには注意
- 現在の実装は最新5件のメッセージのみチェック（パフォーマンス考慮）
